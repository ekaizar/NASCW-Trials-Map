<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NACSW Trials Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #header h1 {
            font-size: 20px;
            margin-bottom: 3px;
        }
        
        #header p {
            opacity: 0.9;
            font-size: 12px;
        }
        
        #lastUpdate {
            margin-top: 5px;
            font-size: 11px;
            opacity: 0.8;
        }
        
        #controls {
            background: white;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .controls-container {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .control-group {
            margin-bottom: 0;
        }
        
        .control-group.date-control {
            flex: 0 0 auto;
            min-width: 300px;
        }
        
        .control-group.event-control {
            flex: 1;
            min-width: 400px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 13px;
        }
        
        .date-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .date-inputs input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
        }
        
        #eventTypeCheckboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
            gap: 6px;
            max-height: 85px;
            overflow-y: auto;
            padding: 6px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .checkbox-item input[type="checkbox"] {
            cursor: pointer;
        }
        
        .checkbox-item label {
            cursor: pointer;
            font-weight: normal !important;
            margin: 0 !important;
            font-size: 11px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        #applyFilters {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        #applyFilters:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        #selectAll, #deselectAll {
            background: #f0f0f0;
            color: #333;
        }
        
        #selectAll:hover, #deselectAll:hover {
            background: #e0e0e0;
        }
        
        #map {
            flex: 1;
            width: 100%;
        }
        
        #stats {
            background: white;
            padding: 8px 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            font-size: 13px;
            color: #666;
        }
        
        #loading, #error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 9999;
            text-align: center;
        }
        
        #loading {
            display: block;
        }
        
        #error {
            display: none;
            color: #d32f2f;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            padding: 0;
            overflow: hidden;
        }
        
        .leaflet-popup-content {
            margin: 0;
            min-width: 250px;
        }
        
        .popup-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
        }
        
        .popup-info {
            padding: 8px 15px;
            font-size: 13px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .popup-info:last-of-type {
            border-bottom: none;
        }
        
        .popup-label {
            font-weight: 600;
            color: #666;
        }
        
        .popup-link {
            padding: 12px 15px;
            background: #f9f9f9;
        }
        
        .popup-link a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.2s;
        }
        
        .popup-link a:hover {
            color: #764ba2;
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            #header h1 {
                font-size: 18px;
            }
            
            .controls-container {
                flex-direction: column;
            }
            
            .control-group.date-control,
            .control-group.event-control {
                min-width: 100%;
            }
            
            #eventTypeCheckboxes {
                grid-template-columns: repeat(auto-fill, minmax(85px, 1fr));
                max-height: 120px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>üó∫Ô∏è NACSW Trials Map</h1>
        <p>Interactive map of nose work trials across the United States</p>
        <div id="lastUpdate">Loading...</div>
    </div>
    
    <div id="controls">
        <div class="controls-container">
            <div class="control-group date-control">
                <label>üìÖ Date Range</label>
                <div class="date-inputs">
                    <input type="date" id="dateFrom">
                    <input type="date" id="dateTo">
                </div>
            </div>
            
            <div class="control-group event-control">
                <label>üèÜ Event Types</label>
                <div class="button-group" style="margin-bottom: 6px;">
                    <button id="selectAll">Select All</button>
                    <button id="deselectAll">Deselect All</button>
                </div>
                <div id="eventTypeCheckboxes"></div>
            </div>
        </div>
        
        <div class="button-group">
            <button id="applyFilters">Apply Filters</button>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div id="stats">
        Showing <strong id="eventCount">0</strong> trials
    </div>
    
    <div id="loading">
        <div class="spinner"></div>
        <div>Loading trials data...</div>
    </div>
    
    <div id="error">
        <h3>‚ö†Ô∏è Error Loading Data</h3>
        <p id="errorMessage"></p>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Load trials data -->
    <script src="data.js"></script>
    
    <script>
        // ===== MAP INITIALIZATION =====
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // ===== STATE VARIABLES =====
        let allEvents = [];
        let markers = [];
        
        // ===== EVENT COLORS =====
        const eventColors = {
            'NW1': '#4A90E2',
            'NW2': '#357ABD',
            'NW3': '#2C5F8D',
            'ELT': '#9B59B6',
            'ELT-S': '#8E44AD',
            'ELT-P': '#7D3C98',
            'SMT': '#27AE60',
            'EST': '#229954',
            'DST': '#1E8449',
            'L1I': '#E67E22',
            'L1C': '#E67E22',
            'L1V': '#E67E22',
            'L1E': '#E67E22',
            'L2I': '#D35400',
            'L2C': '#D35400',
            'L2V': '#D35400',
            'L2E': '#D35400',
            'L3I': '#C0392B',
            'L3C': '#C0392B',
            'L3V': '#C0392B',
            'L3E': '#C0392B',
            'default': '#95A5A6'
        };
        
        // ===== HELPER FUNCTIONS =====
        function getEventColor(eventType) {
            return eventColors[eventType] || eventColors.default;
        }
        
        function createMarkerIcon(color) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${color};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        // ===== LOAD DATA =====
        function loadData() {
            try {
                // Data is already loaded from data.js
                if (typeof TRIALS_DATA === 'undefined') {
                    throw new Error('Trials data not found. Make sure data.js is loaded.');
                }
                
                allEvents = TRIALS_DATA.filter(row => 
                    row.Latitude && row.Longitude && row.Date && row.TrialTypes
                );
                
                // Parse TrialTypes from comma-separated string to array
                allEvents.forEach(trial => {
                    if (typeof trial.TrialTypes === 'string') {
                        trial.TrialTypesArray = trial.TrialTypes.split(',').map(t => t.trim());
                    } else {
                        trial.TrialTypesArray = [];
                    }
                });
                
                if (allEvents.length === 0) {
                    showError('No valid trials found in the data.');
                    return;
                }
                
                // Show last update time
                const dates = allEvents.map(e => new Date(e.Date)).sort((a, b) => b - a);
                const latestDate = dates[0];
                document.getElementById('lastUpdate').textContent = 
                    `Last updated: ${new Date().toLocaleDateString()} | Latest trial: ${formatDate(latestDate)}`;
                
                initializeFilters();
                applyFilters();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                showError(error.message);
            }
        }
        
        // ===== INITIALIZE FILTER CONTROLS =====
        function initializeFilters() {
            // Get unique event types from all trials
            const allEventTypes = new Set();
            allEvents.forEach(trial => {
                trial.TrialTypesArray.forEach(type => allEventTypes.add(type));
            });
            const eventTypes = Array.from(allEventTypes).sort();
            
            // Populate checkboxes
            const checkboxContainer = document.getElementById('eventTypeCheckboxes');
            checkboxContainer.innerHTML = '';
            
            eventTypes.forEach(type => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `type_${type}`;
                checkbox.value = type;
                checkbox.checked = true;
                
                const label = document.createElement('label');
                label.htmlFor = `type_${type}`;
                label.textContent = type;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                checkboxContainer.appendChild(div);
            });
            
            // Set date range: earliest trial date to one year from that date
            const dates = allEvents.map(e => new Date(e.Date)).sort((a, b) => a - b);
            const earliestDate = dates[0];
            const oneYearLater = new Date(earliestDate);
            oneYearLater.setFullYear(earliestDate.getFullYear() + 1);
            
            const minDate = earliestDate.toISOString().split('T')[0];
            const maxDate = oneYearLater.toISOString().split('T')[0];
            
            document.getElementById('dateFrom').value = minDate;
            document.getElementById('dateTo').value = maxDate;
        }
        
        // ===== APPLY FILTERS =====
        function applyFilters() {
            const dateFrom = new Date(document.getElementById('dateFrom').value);
            const dateTo = new Date(document.getElementById('dateTo').value);
            
            // Get checked event types
            const checkedTypes = Array.from(document.querySelectorAll('#eventTypeCheckboxes input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            // Filter trials - show trial if it includes ANY of the selected event types
            const filteredEvents = allEvents.filter(trial => {
                const trialDate = new Date(trial.Date);
                const dateMatch = trialDate >= dateFrom && trialDate <= dateTo;
                
                // Check if trial has any of the selected event types
                const typeMatch = trial.TrialTypesArray.some(type => checkedTypes.includes(type));
                
                return dateMatch && typeMatch;
            });
            
            // Update map
            displayMarkers(filteredEvents);
            
            // Update stats
            document.getElementById('eventCount').textContent = filteredEvents.length;
        }
        
        // ===== GET PRIMARY COLOR FOR TRIAL =====
        function getPrimaryColor(trialTypesArray) {
            if (trialTypesArray.some(t => t.startsWith('L3'))) return eventColors.L3I;
            if (trialTypesArray.some(t => t.startsWith('L2'))) return eventColors.L2I;
            if (trialTypesArray.some(t => t.startsWith('L1'))) return eventColors.L1I;
            if (trialTypesArray.some(t => t.startsWith('ELT'))) return eventColors.ELT;
            if (trialTypesArray.some(t => ['SMT', 'EST', 'DST'].includes(t))) return eventColors.SMT;
            if (trialTypesArray.includes('NW3')) return eventColors.NW3;
            if (trialTypesArray.includes('NW2')) return eventColors.NW2;
            if (trialTypesArray.includes('NW1')) return eventColors.NW1;
            return eventColors.default;
        }
        
        // ===== DISPLAY MARKERS ON MAP =====
        function displayMarkers(trials) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Add new markers with colors based on trial event types
            trials.forEach(trial => {
                const color = getPrimaryColor(trial.TrialTypesArray);
                const icon = createMarkerIcon(color);
                
                const marker = L.marker([trial.Latitude, trial.Longitude], { icon: icon })
                    .bindPopup(createPopupContent(trial))
                    .addTo(map);
                
                markers.push(marker);
            });
            
            // Fit map to show all markers if there are any
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // ===== CREATE POPUP CONTENT =====
        function createPopupContent(trial) {
            // Format event types as a nice list
            const eventTypesList = trial.TrialTypesArray
                .map(type => `<span style="
                    display: inline-block;
                    background: ${getEventColor(type)};
                    color: white;
                    padding: 2px 8px;
                    border-radius: 3px;
                    margin: 2px;
                    font-size: 11px;
                    font-weight: 600;
                ">${type}</span>`)
                .join(' ');
            
            return `
                <div class="popup-title">${trial.Location}</div>
                <div class="popup-info">
                    <span class="popup-label">Date:</span> ${formatDate(trial.Date)}
                </div>
                <div class="popup-info">
                    <span class="popup-label">Host:</span> ${trial.Host}
                </div>
                <div class="popup-info" style="margin-top: 10px;">
                    <strong>Event Types:</strong><br>
                    <div style="margin-top: 5px;">
                        ${eventTypesList}
                    </div>
                </div>
                <div class="popup-link">
                    <a href="${trial.EventLink}" target="_blank" rel="noopener">View Event Details ‚Üí</a>
                </div>
            `;
        }
        
        // ===== EVENT LISTENERS =====
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        
        document.getElementById('selectAll').addEventListener('click', () => {
            document.querySelectorAll('#eventTypeCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
        });
        
        document.getElementById('deselectAll').addEventListener('click', () => {
            document.querySelectorAll('#eventTypeCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
        });
        
        // ===== INITIALIZE =====
        loadData();
    </script>
</body>
</html>
